<!DOCTYPE HTML>
<html>
	<head>

		<title>My Groups - BeeVote</title>

		{{ basic_head }}

		<script>
			$(document).ready(function() {

				$('#topic-form').submit(function() {
						$(this).append('<input type="hidden" name="timezoneOffset" value="'+new Date().getTimezoneOffset()+'" /> ');
						$('#create-topic').attr("disabled", true);
						return true;
					});
					$('#inputDate').datetimepicker({
						timepicker:false,
						format:'d/m/Y'
					});
					$('#inputTime').datetimepicker({
						datepicker:false,
						format:'H:i'
					});
					$('#inputDeadline').datetimepicker({
						format:'d/m/Y H:i'
					});

				checkDisplay("locationButton", "topicWhereInput");
				checkDisplay("dateButton", "topicDateInput");
				checkDisplay("timeButton", "topicTimeInput");
				checkDisplay("deadLineButton", "topicDeadLineInput");

				$('#group-form').ajaxForm({
					// Impostare action a '/api/create-group',
					dataType: "json",
					beforeSubmit: function() {
						$('#create-group').attr("disabled", true);
					},
					error: function() {
						alert("Errore inaspettato!");
					},
					success: function(response) {
						if (response.success) {
							load_groups();
							$('#myModal').modal('hide');
						} else {
							alert(response.error);
						}
						$('#create-group').attr("disabled", false);
					}
				});

				function load_groups() {
					$('#group-list').html("Loading...");
					$('#group-list').load('/html/groups', function() {
						$('div.group-well').on('click', function() {
							if ($(this).hasClass("group-selected")) {
								$('div.group-well').removeClass('group-selected');
								load_all_topics();
							}
							else {
								$('div.group-well').removeClass('group-selected');
								$(this).addClass('group-selected');
								load_group_topics($(this).data('group_id'));
							}
						});
					});
				}
				load_groups();
				load_all_topics();
			});
			function get_topic_list(topics,global_topics) {
				var topic_list = $('<div></div>')
				if (global_topics)
					topic_list.addClass('global-topics');
				topic_list.addClass('list-group');
				$.each( topics, function( index, topic ) {
						var div_list_item = $('<div></div>');
						div_list_item.addClass('list-group-item');
							var a_href = $('<a href="/group/'+topic.data.group_id+'/topic/'+topic.data.id+'">');
								var div_well = $('<div></div>');
								div_well.addClass('well well-lg');
								div_well.attr('color', 'blue');
								div_well.css('padding', '0px');
								div_well.css('padding-top', '10px');
								div_well.css('padding-left', '26px');
								div_well.css('padding-bottom', '6px');
								div_well.css('max-width', '900px');
								div_well.css('margin-left', '20px');
								div_well.css('margin-right', '20px');
									var div_row = $('<div></div>');
									div_row.addClass('row');
										var div_picture = $('<div></div>');
										div_picture.addClass('row-picture');
											var image_src;
											if (topic.data.has_image)
												image_src = "/group/"+topic.data.group_id+"/topic/"+topic.data.id+"/image";
											else
												image_src = "/static/images/topic-icon.png";
										div_picture.append('<img class="circle" src="'+image_src+'" alt="icon">');
									div_row.append(div_picture);
										var div_row_content = $('<div></div>');
										div_row_content.addClass('row-content');
										div_row_content.append('<h3 style="font-size:32px;padding-bottom:5px;margin:0px;">'+topic.data.title+'</h3>');
											var tag_h4 = $('<h4></h4>');
											if (topic.data.place != null)
												tag_h4.append('<span class="mdi-communication-location-on" style="margin-left:5px;"></span>'+topic.data.place);
											if (topic.data.date != null)
												tag_h4.append('<span class="mdi-editor-insert-invitation" style="margin-left:5px;"></span>'+topic.data.date);
											if (topic.data.time != null)
												tag_h4.append('<span class="mdi-action-query-builder" style="margin-left:5px;"></span>'+topic.data.time);
										div_row_content.append(tag_h4);
										if (topic.data.deadline != null) {
											if (topic.expired)
												div_row_content.append('<h5 class="list-group-item-text" style="color: red;">This topic has reached its deadline.</h5>');
											else {
												var time_left = topic.time_before_deadline;
													var tag_h5 = $('<h5 class="list-group-item-text" style="margin-left:5px;">Time before deadline: </h5>');
														var span_red = $('<span style="color: red"></span>')
														if (time_left.days != 0)
															span_red.append(time_left.days+' days ');
														if (time_left.hours != 0)
															span_red.append(time_left.hours+' hours ');
														if (time_left.minutes != 0)
															span_red.append(time_left.minutes+' minutes ');
														if (time_left.seconds != 0)
															span_red.append(time_left.seconds+' seconds ');
													tag_h5.append(span_red);
												div_row_content.append(tag_h5);
											}
										}
										if (topic.data.creator == {{ user.key.id }}) {
												var div_least_content = $('<div></div>');
												div_least_content.addClass('least-content');
												div_least_content.append('<a id="delete-topic" title="Delete this topic" href="/group/'+topic.data.group_id+'/topic/'+topic.data.id+'/remove" class="btn btn-danger mdi-action-delete"></a>');
											div_row_content.append(div_least_content);
										}
									div_row.append(div_row_content);
								div_well.append(div_row);
							a_href.append(div_well);
						div_list_item.append(a_href);
					topic_list.append(div_list_item);
				});
				return topic_list;
			}
			function load_group_topics(group_id) {
				$('div#right-column').html('Loading...');
				$.ajax({
					url: '/api/group/'+group_id,
					method: 'GET',
					data: {
						'fetch_group_members': true,
						'fetch_topics': true,
						'evaluate_deadlines': true
					},
					success: function(group) {
						var topic_column = $('div#right-column');
						topic_column.html('');
							var group_head = $('<div></div>');
							group_head.addClass('jumbotron')
							group_head.css('background-color', '#f44336');
							group_head.css('max-width', '900px');
							group_head.css('margin-right', '20px');
							group_head.css('margin-left', '20px');
							group_head.append('<h1 style="margin-top:-15px;color:#000000">'+group.data.name+'</h1>');
								var div_row = $('<div></div>');
								div_row.addClass('row');
									var col_lg_sx = $('<div></div>');
									col_lg_sx.addClass('col-lg-5');
										var img_src;
										if(group.data.has_image)
											img_src = "/group/"+group.data.id+"/image";
										else
											img_src = "/static/images/group-default-240x240.jpg";
									col_lg_sx.append('<img src="'+img_src+'" alt="icon" style="max-width:100%;max-height:175px;margin-top:5px;">');
								div_row.append(col_lg_sx);
									var col_lg_cx = $('<div></div>');
									col_lg_cx.addClass('col-lg-5');
									col_lg_cx.append('<h2><small style="color:#000">'+group.data.description+'</small></h2>');
								div_row.append(col_lg_cx);
									var col_lg_dx = $('<div></div>');
									col_lg_dx.addClass('col-lg-1');
									//group_head.append('<a href="/group/'+group.data.id+'/members"><button class="btn" style="background-color:#FFFFFF">Add members</button></a>');
									col_lg_dx.append('<button type="submit" class="btn btn-info btn-fab btn-raised mdi-social-people" data-toggle="modal" data-target="#addMembers"></button>');
									//col_lg_dx.append('<a href="/group/'+group.data.id+'"><button class="btn" style="background-color:#FFFFFF">View group</button></a>');
								div_row.append(col_lg_dx);
							group_head.append(div_row);
							$('span#group_name').html(group.data.name);
							$('input#groupId').val(group.data.id);
							var member_list = $('div#member_list');
							member_list.html('');
							$.each(group.members, function(index, member) {
									var div_list_item = $('<div></div>');
									div_list_item.addClass('list-group-item');
										var div_row_picture = $('<div></div>');
										div_row_picture.addClass('row-picture');
										div_row_picture.append('<img class="circle" src="/static/images/user-default.jpg" alt="icon">');
									div_list_item.append(div_row_picture);
										var div_row_content = $('<div></div>');
										div_row_content.addClass('row-content');
										div_row_content.append('<h4 class="list-group-item-heading">'+member.data.name+' '+member.data.surname+'</h4>');
										div_row_content.append('<p>'+member.data.email+'</p>');
										div_row_content.append('<form action="/group/'+group.data.id+'/members/remove" method="POST"><input type="text" id="email" name="email" value="'+member.data.email+'" hidden><div class="least-content"><button type="submit" class="btn btn-danger btn-fab btn-raised mdi-action-delete"></button></div></form>');
									div_list_item.append(div_row_content);
									var line_separator = $('<div></div>');
										line_separator.addClass('list-group-separator');
								member_list.append(div_list_item);
							});

						topic_column.append(group_head);
							var div_topics = $('<div style="margin-left:25px;"><h2>Topics</h2></div><button class="btn btn-fab btn-raised btn-material-blue" data-toggle="modal" data-target="#createTopic" style="background-color:#2196F3;z-index:10;position:fixed;bottom:10px;right:10px;"><i class="mdi-content-add" ></i></button>');
						topic_column.append(div_topics);
						topic_column.append(get_topic_list(group.topics, false));
						$('form#add-member-form').attr('action', '/group/'+group.data.id+'/members/add');
					}
				});
			}
			function load_all_topics() {
				$('div#right-column').html('Loading...');
				$.ajax({
					url: '/api/groups',
					method: 'GET',
					data: {
						'fetch_topics': true,
						'evaluate_deadlines': true
					},
					success: function(groups) {
						var topic_column = $('div#right-column');
						topic_column.html('');
						topic_column.append('<h2>List of all topics</h2>');
						topic_column.append('<br>');
						
						var topics = [];
						$.each(groups, function(index, group) {
							topics = topics.concat(group.topics);
						})
						
						topic_column.append(get_topic_list(topics, true));
					}
				});
			}

		function checkDisplay(button, field) {
			$('#'+button).on('click', function() {
				$('#'+field+' input').val('');
				$(this).toggleClass('selected');
				$('#'+button).css('background-color', $(this).hasClass('selected') ? '#40FF40' : '#2196F3');
				$('#'+field).css('display', $(this).hasClass('selected') ? 'block' : 'none');
			});
		};
		</script>
		
	</head>

	<body>

		{{ navbar }}



		<!-- Popup-Form New Group -->
		<div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h2 align="center">
							<b>Create a new Group</b>
						</h2>
					</div>
					<div class="modal-body">
						<form action="/api/create-group" method="post" class="form-horizontal" enctype="multipart/form-data" id="group-form">
							<fieldset>
								<div class="form-group">
									<label for="inputGroupName" class="col-lg-2 control-label">Name: </label>
									<div class="col-lg-10">
										<input class="form-control" id="inputGroupName" name="name" placeholder="Name of the group" type="text" maxlength="32" required>
									</div>
								</div>
								<div class="form-group">
									<label for="textArea" class="col-lg-2 control-label">Description</label>
									<div class="col-lg-10">
										<textarea class="form-control" rows="3" id="inputDescription" name="description"></textarea>
										<span class="help-block">Add here a description of the group</span>
									</div>
								</div>

								<div class="form-group" >
									<label for="inputImg" class="col-lg-2 control-label">Photo:</label>
									<div class="col-lg-10">
										<input id="inputImg" type="file" name="img"/>
									</div>
								</div>
								
								<!-- OLD BUTTON 
								<div class="form-group">
								<div class="col-lg-10 col-lg-offset-2">
								<button type="button" data-toggle="modal" data-target="#myModal" class="btn btn-default">Cancel</button>
								<button type="submit" class="btn btn-info">Create</button>
								</div>
								</div>
								-->

								<!-- NEW BUTTON -->
								<div class="form-group">
									<div class="modal-footer">
										<button type="button" class="btn btn-default" data-dismiss="modal" data-target="#myModal">Cancel</button>
										<button type="submit" class="btn" id="create-group" style="background-color:#f44336;">Create</button>
									</div>
								</div>
							</fieldset>
						</form>
					</div>
				</div>
			</div>
		</div>

		<!-- Popup-Add members -->
		<div id="addMembers" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					
					<div class="modal-body">
						
							<div class="list-group">
								<h2 align="center">Members of "<span id="group_name"></span>"</h2>
								<div class="jumbotron" style="padding-bottom: 1px; padding-top: 1px;">
									<form id="add-member-form" class="form-horizontal" action="/group/{{ group.key.id }}/members/add" method="POST">
										<fieldset>
											<div class="form-group" style="padding:19px;">
												<legend>Add member</legend>
												<div class="input-group">
													<input type="email" class="form-control" id="email" name="email" placeholder="Email">
													<span class="input-group-btn">
														<button type="submit" class="btn btn-info btn-fab btn-raised mdi-social-person-add"></button>
													</span>
												</div>
											</div>
										</fieldset>
									</form>
									{% if unknown_email %}
									<div class="alert alert-dismissable alert-warning" style="max-width: 900px; margin-left: auto; margin-right: auto; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.23), 0 3px 10px rgba(0, 0, 0, 0.16);">
										<button type="button" class="close" data-dismiss="alert">X</button>
										<h3 style="margin-top: 0px;">{{ unknown_email.0.0 }} is not associated to any BeeVote account.</h3>
									</div>
									{% endif %}
								</div>
								<div id="member_list">
									<!-- {% for user in group.members_data %}
									<div class="list-group-item">
										<div class="row-picture">
											<img class="circle" src="/static/images/user-default.jpg" alt="icon">
										</div>
										<div class="row-content">
											<h4 class="list-group-item-heading">{{user.name}} {{user.surname}}</h4>
											<p>{{user.email}}</p>
											<form action="/group/{{ group.key.id }}/members/remove" method="POST">
												<input type="text" id="email" name="email" value="{{ user.email }}" hidden>
												<div class="least-content">
													<button type="submit" class="btn btn-danger btn-fab btn-raised mdi-action-delete"></button>
												</div>
											</form>
										</div>
									</div>
									</div>
									<div class="list-group-separator"></div>
									{% endfor %} -->
								</div>
							</div>
						
					</div>
				</div>
			</div>
		</div>

		<!-- Popup-CreateTopic -->
		<div id="createTopic" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h2 align="center"><b>Create a new Topic</b></h2>
					</div>
					<div class="modal-body">
						<form action="/create-topic" method="post" class="form-horizontal" enctype="multipart/form-data" id="topic-form">
							<fieldset>
								<input id="groupId" type="hidden" name="groupId">
								<div><h4 style="text-align:center;">Title</h4></div>
								<div class="list-group">
									<div class="form-group">
										<div class="col-lg-10" style="margin-left:45px;">
											<input class="form-control" id="inputTopicName" name="inputTopicName" placeholder="Title of the Topic" type="text" maxlength="64" required>
										</div>
									</div>
									<!-- NEW INPUT FILE-->
									<div class="list-group-separator" style="border-bottom: 3px solid #2196F3"></div>
									<div>
										<h4 style="text-align:center;">
											Details
										</h4>
									</div>
									<!-- <div class="row">
										<div class="col-lg-3">
											<div class="list-group-item">
												<h4> Place </h4>
											</div>
										</div>
										<div class="col-lg-3">
											<div class="list-group-item">
												<h4> Date </h4>
											</div>
										</div>
										<div class="col-lg-3">
											<div class="list-group-item">
												<h4> Time </h4>
											</div>
										</div>
										<div class="col-lg-3">
											<div class="list-group-item">
												<h4> Deadline </h4>
											</div>
										</div>
									</div> -->
									<div class="list-group">
										<div class="row">
											<div class="col-lg-3">
												<div class="list-group-item">
													<h4> Place </h4>
													<button type="button" class="btn btn-info btn-fab btn-raised  mdi-communication-location-on" id="locationButton"></button>
												</div>
											</div>
											<div class="col-lg-3">
												<div class="list-group-item">
													<h4> Date </h4>
													<button  type="button" class="btn btn-info btn-fab btn-raised mdi-editor-insert-invitation" id="dateButton"></button>
												</div>
											</div>
											<div class="col-lg-3">
												<div class="list-group-item">
													<h4> Time </h4>
													<button type="button" class="btn btn-info btn-fab btn-raised mdi-action-query-builder" id="timeButton"></button>
												</div>
											</div>
											<div class="col-lg-3">
												<div class="list-group-item">
													<h4> Deadline </h4>
													<button type="button" class="btn btn-info btn-fab btn-raised mdi-notification-event-busy" id="deadLineButton"></button>
												</div>
											</div>
											<div class="form-group" id="topicWhereInput" style="display:none;">
												<label for="inputWhere" class="col-lg-2 control-label">Place: </label>
												<div class="col-lg-10">
													<input class="form-control" id="inputWhere" name="inputWhere" placeholder="Location for the activities " type="text">
												</div>
											</div>
											<div class="form-group" id="topicDateInput" style="display:none;">
												<label for="inputDate" class="col-lg-2 control-label">Date: </label>
												<div class="col-lg-10">
													<input class="form-control" id="inputDate" name="inputDate" placeholder=" Which date " autocomplete="off">
												</div>
											</div>
											<div class="form-group" id="topicTimeInput" style="display:none;">
												<label for="inputTime" class="col-lg-2 control-label">Time: </label>
												<div class="col-lg-10">
													<input class="form-control" id="inputTime" name="inputTime" placeholder="At what time " autocomplete="off">
												</div>
											</div>
											<div class="form-group" id="topicDeadLineInput" style="display:none;">
												<label for="inputDeadline" class="col-lg-2 control-label">Expire Date: </label>
												<div class="col-lg-10">
													<input class="form-control" id="inputDeadline" name="inputDeadline" autocomplete="off" placeholder="Fill this field if you want to set an expire time for the topic">
												</div>
											</div>
											<div class="list-group-separator" style="border-bottom: 3px solid #2196F3;padding-top:20px;"></div>
											<br>
											<div class="form-group" >
												<label for="inputImg" class="col-lg-2 control-label">Photo:</label>
												<div class="col-lg-10">
													<input id="inputImg" type="file" name="inputImg"/>
												</div>
											</div>
											<div class="form-group">
												<label for="textArea" class="col-lg-2 control-label">Other details: </label>
												<div class="col-lg-10">
													<textarea class="form-control" rows="3" id="inputDescription" name="inputDescription"></textarea>
													<span class="help-block">Add here details that you want the others will know </span>
												</div>
											</div>
										</div>
									</div>
									<!-- NEW BUTTON -->
									<div class="form-group">
										<div class="modal-footer">
											<button type="button" class="btn btn-default" data-dismiss="modal" data-target="#myModal">Cancel</button>
											<button type="submit" class="btn btn-info" id="create-topic">Create</button>
										</div>
									</div>
								</fieldset>
							</form>
						</div>
					</div>
				</div>
			</div>	
		</div>

		<!-- Jumbotron Contenitore -->
		<div class="jumbotron" style="background-color: #EEEEEE; box-shadow: 0 3px 10px rgba(0, 0, 0, 0), 0 3px 10px rgba(0, 0, 0, 0); padding: 0px;">
			<div class="row">
				<!-- Colonna sinistra -->
				<div class="col-lg-5" style="padding-left:60px;">
					<!-- Jumbotron con immagine profilo -->
					<div class="jumbotron" style="margin-left:13px;background-color: #2196F3; width: 100%;">
						<div class="row">
							<div class="col-lg-12">
								<div class="row-picture">
									<img style="width: 90px; height: 90px; border-radius: 100%;" class="circle" src="/static/images/user-default.jpg" alt="icon"/>
								</div>
								<br>
								<h4 class="list-group-item-heading" color="black">
									<b>{{user.name}} {{user.surname}}</b>
								</h4>
							</div><!-- /col-lg-12 -->            
						</div><!-- /row -->
					</div><!-- /jumbotron Immagine profilo -->

					<!-- Jumbotron Lista Gruppi -->
					<div style="margin-left:25px;">
						<h2>Your Groups</h2>
						<button class="btn btn-fab btn-raised btn-material-red" data-toggle="modal" data-target="#myModal" style="z-index:10;position:fixed;bottom:10px;left:10px;"><i class="mdi-content-add" style="top: -3px;"></i></button>
					</div>
					<br>
					<div id="group-list"></div>
				</div> <!-- /col-lg-4 -->

				<!-- Colonna destra -->
				<div class="col-lg-7" id="right-column" style="padding-right:60px;">
					
				</div><!-- /col-lg-8 -->
			</div><!-- /row-inizio -->
		</div>
	</body>
</html>