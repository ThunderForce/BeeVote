<script src="/static/js/vote-functions.js"></script>
<script>
$(document).ready(function() {
	$('input#groupId').val("{{ topic.group.key.id }}");
	$('button#delete-topic').on('click', function() {
		if (confirm("Are you sure to delete this topic?")) {
			$.ajax({
				url: '/api/group/{{ topic.parent.key.id }}/topic/{{ topic.key.id }}/remove',
				method: 'POST',
				dataType: 'json',
				error: function() {
					alert("Errore inaspettato!");
				},
				success: function(response) {
					if (response.success) {
						load_group_topics(response.group_id);
					} else {
						alert(response.error);
					}
				}
			});
		}
	});
	$("div.proposal-well").on("click", function() {
		var proposal_id = $(this).data("proposal");
		$("div.proposal-details[data-proposal='" + proposal_id +"']").toggle({duration: 400});
	});
	$('input#proposal_popup_group_id').val("{{ topic.group.key.id }}");
	$('input#proposal_popup_topic_id').val("{{ topic.key.id }}");
	$('#creation-buttons').html('');
	$('#creation-buttons').append(buttons.create_proposal);
	$('#creation-buttons').append(buttons.create_topic);
	$('#creation-buttons').append(buttons.create_group);
	
	{% if topic.place != "" %}
		$('div#proposal_place_div').hide();
	{% else %}
		$('div#proposal_place_div').show();
	{% endif %}
	{% if topic.date %}
		$('div#proposal_date_div').hide();
	{% else %}
		$('div#proposal_date_div').show();
	{% endif %}
	{% if topic.time %}
		$('div#proposal_time_div').hide();
	{% else %}
		$('div#proposal_time_div').show();
	{% endif %}
	
	{% if topic.expired %}
		$('button#create-proposal-button').attr("disabled", true).css('background-color', '#888888');
	{% endif %}
	
	$('.vote-checkbox').on('click', function(e) {

		var group_id = {{ topic.parent.key.id }};
		var topic_id = {{ topic.key.id }};
		var proposal_id = $(this).data("proposal");

		$("span.vote-number[data-proposal='" + proposal_id +"']").html("...");
		success_callback = function(response) {
			$("span.vote-number[data-proposal='" + proposal_id +"']").html(response.vote_number);
			$("button.vote-checkbox[data-proposal='" + proposal_id +"']").removeClass("proposal-pending-vote disabled");
		};

		$(this).toggleClass("proposal-voted proposal-not-voted");
		$(this).addClass("proposal-pending-vote disabled")
		if ($(this).hasClass("proposal-voted"))
			add_vote(group_id, topic_id, proposal_id, success_callback);
		else
			remove_vote(group_id, topic_id, proposal_id, success_callback);

		if (e.stopPropagation) {
				e.stopPropagation();   // W3C model
			} else {
				e.cancelBubble = true; // IE model
			}
	});
	$('input#topic-participation').on('click', function() {
		var checked = $(this).is(':checked');
		$(this).attr('disabled', true)
		if (checked) {
			$.ajax({
				url: '/api/group/{{ topic.group.key.id }}/topic/{{ topic.key.id }}/add-participation',
				method: 'POST',
				dataType: 'json',
				success: function(response) {
					if (response.success) {
						load_topic(response.group_id, response.topic_id);
					} else {
						alert("Error");
					}
				}
			})
		} else {
			$.ajax({
				url: '/api/group/{{ topic.group.key.id }}/topic/{{ topic.key.id }}/remove-participation',
				method: 'POST',
				dataType: 'json',
				success: function(response) {
					if (response.success) {
						load_topic(response.group_id, response.topic_id);
					} else {
						alert("Error");
					}
				}
			})
		}
	});
});

$('#updateImage-form').ajaxForm({
					dataType: "json",
					beforeSubmit: function() {
						$('#edit-image').attr("disabled", true);
					},
					clearForm: true,
					error: function() {
						alert("Unexpected error!");
					},
					success: function(response) {
						if (response.success) {
							load_topic(response.group_id, response.topic_id);
							$('#updateImage').modal('hide');
						} else {
							alert(response.error);
						}
						$('#edit-image').attr("disabled", false);
					}
	});

$('#edit-cancel').on('click', function() {
					resetForm("updateImage-form");
				});



</script>

<!--
<div class="topic-overview">
	<div class="jumbotron" style="max-width:900px; background-color:#2196F3;padding:0px;padding-left:18px;">
		<h2 style="word-wrap:break-word;padding-top:5px;margin-bottom:5px;font-size:40px;">{{ topic.title }}</h2>
		<div class="list-group-separator" style="border-bottom: 1px solid #FFFFFF;margin-right:18px;"></div>
		{% if topic.expired %}
		<p style="color: red;">This topic has reached its deadline: you cannot vote its proposals anymore.</p>
		{% else %}
		{% if topic.time_before_deadline %}
		<p style="margin-top:10px;margin-bottom:0px;">Deadline: {{ topic.deadline }}</p>
		<p>Time before deadline: 
			<span style="color: red">
				{% if topic.time_before_deadline.days != 0 %}
				{{ topic.time_before_deadline.days }} days
				{% endif %}
				{% if topic.time_before_deadline.hours != 0 %}
				{{ topic.time_before_deadline.hours }} hours
				{% endif %}
				{% if topic.time_before_deadline.minutes != 0 %}
				{{ topic.time_before_deadline.minutes }} minutes
				{% endif %}
			</span>
		</p>
		{% endif %}
		{% endif %}
		<div class="row" style="margin-top:10px;">
			<div class="col-lg-5">
				{% if topic.img != None %}
				<img src="/group/{{ topic.parent.key.id }}/topic/{{ topic.key.id }}/image" style=" display: inline-block; max-height: 175px; max-width: 100%;">
				<br><br>
				{% endif %}
				{% if topic.img == None %}
				<i>No image available</i>
				<br><br>
				{% endif %}
			</div>
			
			<div class="col-lg-4">
				<p style="font-size:15px;"><span class="mdi-action-account-box"></span> <b>{{ topic.creator.name }} {{ topic.creator.surname }}</b> </p>
				{% if topic.place != "" %}
				<p style="font-size:15px;"><span class="mdi-communication-location-on"></span> <b>{{ topic.place }}</b> </p>
				{% endif %}
				{% if topic.date %}
				<p style="font-size:15px;"><span class="mdi-editor-insert-invitation"></span> <b>{{ topic.date }}</b> </p>
				{% endif %}
				{% if topic.time %}
				<p style="font-size:15px;"><span class="mdi-action-query-builder"></span> <b>{{ topic.time }}</b> </p>
				{% endif %}
			</div>
		</div>
		{% if topic.is_own %}
		<div class="row">
			<div class="col-lg-10"><p style="word-wrap:break-word;">{{ topic.description }}</p></div>
			<div class="col-lg-2" style="padding:0px;">
				<button id="delete-topic" title="Delete this topic" class="btn btn-danger mdi-action-delete" style="margin-left:5px;"></button>
			</div>
		</div>
		{% endif %}
	</div>
-->

<div class="list-group">
	<div class="list-group-item">
		<div class="well well-lg proposal-well" color="blue" style="padding: 10px 0px 0px 25px;">
			<div class="row">
				<div class="row-picture" style="width:200px;height:100%;margin-bottom:10px;">
					{% if topic.img != None %}
					<img src="/group/{{ topic.parent.key.id }}/topic/{{ topic.key.id }}/image" style="width:200px;height:100%;">
					{% else %}
					<img src="/static/images/topic-icon.png" style="width:200px;height:100%;">
					{% endif %}
					{% if topic.is_own %}
							<div style="position:absolute;top:0px;"><button type="button" class="btn btn-info btn-raised mdi-content-create" data-toggle="modal" data-target="#updateImage" style="padding:7px;"></button></div>
						{% endif %}
				</div>
				<div class="row-content" style="width:66%;margin-top:10px;">
					<div class="col-lg-11">
						<h2 style="word-wrap:break-word;font-size:25px;padding-bottom:5px;margin:0px;">
							{{ topic.title }}
						</h2>
						<p style="word-wrap:break-word;font-size:15px;margin-left:10px;">{{ topic.description }}</p>
						<p style="font-size:15px;margin:0;"><span class="mdi-action-account-box" style="margin-left:10px;"></span>&nbsp;{{ topic.creator.name }} {{ topic.creator.surname }}</p>
						{% if topic.place != "" %}
						<p style="font-size:15px;margin:0;"><span class="mdi-communication-location-on" style="margin-left:10px;"></span>&nbsp;{{ topic.place }}</p>
						{% endif %}
						{% if topic.formatted_date %}
						<p style="font-size:15px;margin:0;"><span class="mdi-editor-insert-invitation" style="margin-left:10px;"></span>&nbsp;{{ topic.formatted_date }}</p>
						{% endif %}
						{% if topic.time %}
						<p style="font-size:15px;margin:0;"><span class="mdi-action-query-builder" style="margin-left:10px;"></span>&nbsp;{{ topic.time }}</p>
						{% endif %}
						{% if topic.expired %}
						<br>
						<p style="font-size:15px;margin:0;">This topic has reached its deadline: you cannot vote its proposals anymore.</p>
						{% else %}
						{% if topic.time_before_deadline %}
						<p style="font-size:15px;margin:0;">
							<span class="mdi-notification-event-busy" style="margin-left:10px;"></span>&nbsp;
							<span>
								{% if topic.time_before_deadline.days != 0 %}
								{{ topic.time_before_deadline.days }} days
								{% endif %}
								{% if topic.time_before_deadline.hours != 0 %}
								{{ topic.time_before_deadline.hours }} hours
								{% endif %}
								{% if topic.time_before_deadline.minutes != 0 %}
								{{ topic.time_before_deadline.minutes }} minutes
								{% endif %}
							</span>
						</p>
						{% endif %}
						{% endif %}
					</div>
				</div>
				{% if topic.is_own %}
						<div style="float:right;margin-right:25px;"><button id="delete-topic" title="Delete this topic" class="btn btn-danger btn-raised mdi-action-delete" style="background-color:#DB4438"></button></div>
				{% endif %}
			</div>
			<input type="checkbox" id="topic-participation"{% if topic.participation %} checked{% endif %}>I participate
		</div>
	</div>
</div>

	<div class="list-group">
		<h2 style="margin-left:20px;">Proposals</h2>
		{% if not topic.proposals %}
			<p style="margin-left:20px;">This topic has no proposals yet.</p>
		{% endif %}
		{% for proposal in topic.proposals %}
		<div class="list-group-item">
			<div data-proposal="{{ proposal.key.id }}" class="well well-lg proposal-well" color="yellow_g" style="cursor: pointer;padding: 10px 0px 0px 25px;">
				<div class="row">
					<!-- interno proposta -->
					<div class="row-picture">
						<img class="circle" src="/static/images/user-default.jpg" alt="icon">
					</div>
					<div class="row-content">
						<div class="col-lg-11" style="width:70%;">
							<h3 style="font-size:20px;padding-bottom:5px;margin:0px;">
								{{ proposal.title }}
							</h3>
							{% if proposal.place %}
							<span class="mdi-communication-location-on" style="margin-left:5px;"></span> {{ proposal.place }}
							{% endif %}
							{% if proposal.formatted_date %}
							<span class="mdi-editor-insert-invitation" style="margin-left:5px;"></span> {{ proposal.formatted_date }}
							{% endif %}
							{% if proposal.time %}
							<span class="mdi-action-query-builder" style="margin-left:5px;"></span> {{ proposal.time }}
							{% endif %}
							<span class="mdi-action-account-box" style="margin-left:5px;"></span> {{ proposal.creator.name }} {{ proposal.creator.surname }}
							<span class="proposal-details-message" data-proposal="{{ proposal.key.id }}" style="display: none;"><small> (Loading...)</small></span>
							<div class="proposal-details" data-proposal="{{ proposal.key.id }}" style="display: none;">
								{% if proposal.description %}
								<br>
								<span class="mdi-editor-format-align-left" style="margin-left:5px;"></span> {{ proposal.description }}
								{% endif %}
							</div>
						</div>
						<div class="least-content" style="top:5px;right:20px;">
							<b>Votes: </b><span class="badge vote-number" data-proposal="{{ proposal.key.id }}">{{ proposal.vote_number }}</span>&nbsp;
							<button id="vote" data-proposal="{{ proposal.key.id }}" type="checkbox" class="btn btn-default btn-fab btn-raised mdi-action-thumb-up vote-checkbox {% if proposal.already_voted %}proposal-voted{% else %}proposal-not-voted{% endif %}" style="width: 40px; height: 40px;  padding: 8px;" {% if topic.expired or not topic.participation %} disabled {% endif %}></button>
						</div>
					</div>
				</div>
			</div>
		</div>
		{% endfor %}
	</div>

	<!-- Form-update-image -->
	<div id="updateImage" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-body" style="padding:15px 15px 0px 15px;">
						<form action="/api/group/{{topic.parent.key.id }}/topic/{{topic.key.id}}/update" method="post" class="form-horizontal" enctype="multipart/form-data" id="updateImage-form">
							<fieldset>
								<div class="form-group" >
									<label for="inputImg" class="col-lg-2 control-label">Photo: maximum image size is 1 MB</label>
									<div class="col-lg-10">
										<input id="inputImg" type="file" name="img"/>
									</div>
								</div>
								<div class="form-group">
									<div class="modal-footer" style="padding:0px 25px 0px 0px">
										<button type="button" id="edit-cancel" class="btn btn-default" data-dismiss="modal" data-target="#updateImage">Cancel</button>
										<button type="submit" class="btn" id="edit-image" style="background-color:#00A65E;">Edit</button>
									</div>
								</div>
							</fieldset>
						</form>
					</div>
				</div>
			</div>
	</div>

</div>