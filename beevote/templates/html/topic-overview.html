<script src="/static/js/vote-functions.js"></script>
<script>
function initialize_proposal_map(id, place) {
	var geocoder = new google.maps.Geocoder();
	var address_proposal = place;

	geocoder.geocode( { 'address': address_proposal}, function(results, status) {

		if (status == google.maps.GeocoderStatus.OK) {
			var latitude = results[0].geometry.location.lat();
			var longitude = results[0].geometry.location.lng();


			var latlng = new google.maps.LatLng(latitude,longitude);

			var myOptions = {
				zoom: 14,
				center: latlng,
				mapTypeId: google.maps.MapTypeId.ROADMAP,
				mapTypeControl: false
			};

			var map = new google.maps.Map($('#map_canvas_proposal[data-proposal="'+id+'"]')[0],myOptions);
			
			var marker = new google.maps.Marker({
				position: latlng, 
				map: map, 
				title: place
			});
			window.setTimeout(function() {
				google.maps.event.trigger(map, 'resize');
				map.panTo(marker.getPosition());
			}, 250
			);
		}
		else {
			$('#map_canvas_proposal[data-proposal="'+id+'"]').css('display', 'none');
		}
	});
};
$(document).ready(function() {
	$('#topic_image').css('width', '99%');$('#topic_image').css('width', '100%');
	$('input#groupId').val("{{ topic.group.key.id }}");
	$('#back-button').on('click', function(e) {
		load_group_topics('{{ topic.group.key.id }}');
	});

	$('button#delete-topic').on('click', function() {
		if (confirm("Are you sure to delete this topic?")) {
			$.ajax({
				url: '/api/group/{{ topic.parent.key.id }}/topic/{{ topic.key.id }}/remove',
				method: 'POST',
				dataType: 'json',
				error: function() {
					alert("Errore inaspettato!");
				},
				success: function(response) {
					if (response.success) {
						load_group_topics(response.group_id);
					} else {
						alert(response.error);
					}
				}
			});
		}
	});
	$("div.proposal-well").on("click", function() {
		var proposal_id = $(this).data("proposal");
		$("div.proposal-details[data-proposal='" + proposal_id +"']").toggle({duration: 400});
		initialize_proposal_map(proposal_id, $(this).data("place"));
	});
	$('input#proposal_popup_group_id').val("{{ topic.group.key.id }}");
	$('input#proposal_popup_topic_id').val("{{ topic.key.id }}");
	$('#creation-buttons').html('');
	$('#creation-buttons').append(buttons.create_proposal);
	$('#creation-buttons').append(buttons.create_topic);
	$('#creation-buttons').append(buttons.create_group);
	
	{% if topic.place != "" %}
	$('div#proposal_place_div').hide();
	{% else %}
	$('div#proposal_place_div').show();
	{% endif %}
	{% if topic.date %}
	$('div#proposal_date_div').hide();
	{% else %}
	$('div#proposal_date_div').show();
	{% endif %}
	{% if topic.time %}
	$('div#proposal_time_div').hide();
	{% else %}
	$('div#proposal_time_div').show();
	{% endif %}
	
	{% if topic.expired %}
	$('button#create-proposal-button').attr("disabled", true).css('background-color', '#888888');
	{% endif %}
	
	$('.vote-checkbox').on('click', function(e) {

		var group_id = {{ topic.parent.key.id }};
		var topic_id = {{ topic.key.id }};
		var proposal_id = $(this).data("proposal");

		$("span.vote-number[data-proposal='" + proposal_id +"']").html("...");
		success_callback = function(response) {
			$("span.vote-number[data-proposal='" + proposal_id +"']").html(response.vote_number);
			$("button.vote-checkbox[data-proposal='" + proposal_id +"']").removeClass("proposal-pending-vote disabled");
		};

		$(this).toggleClass("proposal-voted proposal-not-voted");
		$(this).addClass("proposal-pending-vote disabled")
		if ($(this).hasClass("proposal-voted"))
			add_vote(group_id, topic_id, proposal_id, success_callback);
		else
			remove_vote(group_id, topic_id, proposal_id, success_callback);

		if (e.stopPropagation) {
			e.stopPropagation();   // W3C model
		} else {
			e.cancelBubble = true; // IE model
		}
	});

	/* Prova per non propagare il clik quando clisso sul voto*/
	$('button#vote-button').on('click', function(e) {

		var group_id = {{ topic.parent.key.id }};
		var topic_id = {{ topic.key.id }};
		var proposal_id = $(this).data("proposal");

		$.ajax({
			url: '/api/load-proposal',
			method: 'GET',
			data: { group_id: group_id, topic_id : topic_id, proposal_id: proposal_id} , 
			dataType: 'json',
			error: function() {
				alert("Errore inaspettato!");
			},
			success: function(response) {
				
				$("#prosalPopupTitle").html(response.proposal.title);

				$("#proposalPopup").html("");
				if(response.proposal.place){
					$("#proposalPopup").append('<span class="mdi-communication-location-on" style="margin-left:5px;"> '+response.proposal.place+' </span>');
				};

				if(response.proposal.date != "None"){
					$("#proposalPopup").append('<span class="mdi-editor-insert-invitation" style="margin-left:5px;"> '+response.proposal.date+' </span>');
				};

				if(response.proposal.time != "None"){
					$("#proposalPopup").append('<span class="mdi-action-query-builder" style="margin-left:5px;"> '+response.proposal.time+' </span>');
				};
				$("#proposalPopup").append('<span class="mdi-action-account-box" style="margin-left:5px;"> '+response.proposal.creator.name+' '+response.proposal.creator.surname+' </span>');
				
				/*"<li>"+response.proposal.place+"</li>"+"<li>"+response.proposal.date+"</li>"+"<li>"+response.proposal.time+"</li>");*/

				$('#voteList').modal('show');
				$('#member-vote-list').html('Loading...');
				var success_callback = function(response) {
					$('#member-vote-list').html('');
					if (response.votes.length == 0){
						$('#message').html('<h3> No one has voted this proposal yet...</h3>');
					} else {
						$('#message').html('<h3> These members voted this proposal </h3>');
				
						$.each(response.votes, function(index, vote) {
							var str = '<div class="list-group-item"><div class="row-picture">';
							if (vote.creator.data.has_image)
								str += '<img class="circle" src="/user/'+vote.creator.data.id+'/image" alt="icon">';
							else
								str += '<img class="circle" src="/static/images/user-default.jpg" alt="icon">';
							str += '</div><div class="row-content"><h3 class="list-group-item-heading">'+vote.creator.data.name+' '+vote.creator.data.surname+'</h3></div></div><div class="list-group-separator"></div>'
							$('#member-vote-list').append(str);
						});
					}
				}
				load_votes("{{ topic.parent.key.id }}", "{{ topic.key.id }}", proposal_id, success_callback);
			}
		});
	
		if (e.stopPropagation) {
			e.stopPropagation();   // W3C model
		} else {
			e.cancelBubble = true; // IE model
		}
	});
	
	$('#topic-participation').on('click', function() {
		$(this).toggleClass('btn-success btn-warning mdi-toggle-check-box mdi-toggle-check-box-outline-blank');
		$(this).addClass('disabled')
		$('span#participation-text').html('Changing...');
		var checked = $(this).hasClass('btn-success');
		$(this).attr('disabled', true)
		if (checked) {
			$.ajax({
				url: '/api/group/{{ topic.group.key.id }}/topic/{{ topic.key.id }}/add-participation',
				method: 'POST',
				dataType: 'json',
				success: function(response) {
					if (response.success) {
						load_topic(response.group_id, response.topic_id);
					} else {
						alert("Error");
					}
				}
			})
		} else {
			$.ajax({
				url: '/api/group/{{ topic.group.key.id }}/topic/{{ topic.key.id }}/remove-participation',
				method: 'POST',
				dataType: 'json',
				success: function(response) {
					if (response.success) {
						load_topic(response.group_id, response.topic_id);
					} else {
						alert("Error");
					}
				}
			})
		}
	});
	$('.proposal-map').on('click', function(e) {
	    if (e.stopPropagation) {
			e.stopPropagation();
		} else {
			e.cancelBubble = true;
		}
	});
	$.material.init();
});

$('#updateImage-form').ajaxForm({
	dataType: "json",
	beforeSubmit: function() {
		$('#edit-image').attr("disabled", true);
	},
	clearForm: true,
	error: function() {
		alert("Unexpected error!");
	},
	success: function(response) {
		if (response.success) {
			load_topic(response.group_id, response.topic_id);
			$('#updateImage').modal('hide');
		} else {
			alert(response.error);
		}
		$('#edit-image').attr("disabled", false);
	}
});

$('#edit-cancel').on('click', function() {
	resetForm("updateImage-form");
});


var geocoder = new google.maps.Geocoder();
var address_topic = '{{ topic.place }}';

    geocoder.geocode( { 'address': address_topic}, function(results, status) {

      if (status == google.maps.GeocoderStatus.OK) {
        var latitude = results[0].geometry.location.lat();
        var longitude = results[0].geometry.location.lng();


        initialize_topic_place(latitude,longitude);

       }
      else {
       	$('#map_canvas_topic').css('display', 'none');
       } 
    }); 

function initialize_topic_place(latitude,longitude) {
        var latlng = new google.maps.LatLng(latitude,longitude);

        var myOptions = {
          zoom: 14,
          center: latlng,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          mapTypeControl: false
        };
        var map = new google.maps.Map(document.getElementById("map_canvas_topic"),myOptions);

        var marker = new google.maps.Marker({
          position: latlng, 
          map: map, 
            title:"{{ topic.place }}"
        }); 
}
</script>

<!--
-			$(document).ready(function() {
-				if ($('#delete-proposal').length > 0)
-					$('#delete-proposal').on('click', function () {
-						return confirm('Are you sure you want to delete this proposal?');
-					});
-				$("#vote_list_button").on("click", function() {
-					if ($(this).attr("aria-expanded") != "true") {
-						$("#list_of_votes").html("<li>Loading...</li>");
-						var success_callback = function(response) {
-							$("#list_of_votes").html("");
-							$.each(response.votes, function(index, vote) {
-								$("#list_of_votes").append("<li>"+vote.name+" "+vote.surname+"</li>");
-							});
-						}
-						load_votes("{{ proposal.parent.parent.key.id }}", "{{ proposal.parent.key.id }}", "{{ proposal.key.id }}", success_callback);
-					}
-					
-				});
-			});
-			function toggle_vote(group, topic, proposal) {
-				$("#number_of_votes").html("...");
-				success_callback = function(response) {
-					$("#number_of_votes").html(response.vote_number);
-				};
-				if ($("#vote").is(":checked"))
-					add_vote(group, topic, proposal, success_callback);
-				else
-					remove_vote(group, topic, proposal, success_callback);
-			}
-->		

<!--
<div class="topic-overview">
	<div class="jumbotron" style="max-width:900px; background-color:#2196F3;padding:0px;padding-left:18px;">
		<h2 style="word-wrap:break-word;padding-top:5px;margin-bottom:5px;font-size:40px;">{{ topic.title }}</h2>
		<div class="list-group-separator" style="border-bottom: 1px solid #FFFFFF;margin-right:18px;"></div>
		{% if topic.expired %}
		<p style="color: red;">This topic has reached its deadline: you cannot vote its proposals anymore.</p>
		{% else %}
		{% if topic.time_before_deadline %}
		<p style="margin-top:10px;margin-bottom:0px;">Deadline: {{ topic.deadline }}</p>
		<p>Time before deadline: 
			<span style="color: red">
				{% if topic.time_before_deadline.days != 0 %}
				{{ topic.time_before_deadline.days }} days
				{% endif %}
				{% if topic.time_before_deadline.hours != 0 %}
				{{ topic.time_before_deadline.hours }} hours
				{% endif %}
				{% if topic.time_before_deadline.minutes != 0 %}
				{{ topic.time_before_deadline.minutes }} minutes
				{% endif %}
			</span>
		</p>
		{% endif %}
		{% endif %}
		<div class="row" style="margin-top:10px;">
			<div class="col-lg-5">
				{% if topic.img != None %}
				<img src="/group/{{ topic.parent.key.id }}/topic/{{ topic.key.id }}/image" style=" display: inline-block; max-height: 175px; max-width: 100%;">
				<br><br>
				{% endif %}
				{% if topic.img == None %}
				<i>No image available</i>
				<br><br>
				{% endif %}
			</div>
			
			<div class="col-lg-4">
				<p style="font-size:15px;"><span class="mdi-action-account-box"></span> <b>{{ topic.creator.name }} {{ topic.creator.surname }}</b> </p>
				{% if topic.place != "" %}
				<p style="font-size:15px;"><span class="mdi-communication-location-on"></span> <b>{{ topic.place }}</b> </p>
				{% endif %}
				{% if topic.date %}
				<p style="font-size:15px;"><span class="mdi-editor-insert-invitation"></span> <b>{{ topic.date }}</b> </p>
				{% endif %}
				{% if topic.time %}
				<p style="font-size:15px;"><span class="mdi-action-query-builder"></span> <b>{{ topic.time }}</b> </p>
				{% endif %}
			</div>
		</div>
		{% if topic.is_own %}
		<div class="row">
			<div class="col-lg-10"><p style="word-wrap:break-word;">{{ topic.description }}</p></div>
			<div class="col-lg-2" style="padding:0px;">
				<button id="delete-topic" title="Delete this topic" class="btn btn-danger mdi-action-delete" style="margin-left:5px;"></button>
			</div>
		</div>
		{% endif %}
	</div>
-->

<button type="button" class="btn btn-raised mdi-hardware-keyboard-arrow-left" id="back-button" style="background-color:#00A65E;"></button>
<div class="list-group">
	<div class="list-group-item">
		<div class="well well-lg proposal-well" color="blue" style="padding: 10px 0px 0px 25px;">
			<div class="row">
				<div class="row-picture" style="width:33%;margin-bottom:10px;">
					{% if topic.img != None %}
					<img id="topic_image" src="/group/{{ topic.parent.key.id }}/topic/{{ topic.key.id }}/image" style="width:200px;height:100%;">
					{% else %}
					<img id="topic_image" src="/static/images/topic-icon.png" style="width:200px;height:100%;">
					{% endif %}
					{% if topic.is_own %}
					<div style="position:absolute;top:0px;"><button type="button" class="btn btn-info btn-raised mdi-content-create" data-toggle="modal" data-target="#updateImage" title="{{lang.buttons.edit_topic_photo_title}}" style="padding:7px;"></button></div>
					{% endif %}
				</div>
				<div class="row-content" style="width:66%;margin-top:10px;">
					<div class="col-lg-11">
						<h2 style="word-wrap:break-word;font-size:25px;padding-bottom:5px;margin:0px;">
							{{ topic.title }}
						</h2>
						<p style="word-wrap:break-word;font-size:15px;margin-left:10px;">{{ topic.description }}</p>
						<p style="font-size:15px;margin:0;"><span class="mdi-action-account-box" style="margin-left:10px;"></span>&nbsp;{{ topic.creator.name }} {{ topic.creator.surname }}</p>
						{% if topic.place != "" %}
						<p style="font-size:15px;margin:0;"><span class="mdi-communication-location-on" style="margin-left:10px;"></span>&nbsp;{{ topic.place }}</p>
						{% endif %}
						{% if topic.formatted_date %}
						<p style="font-size:15px;margin:0;"><span class="mdi-editor-insert-invitation" style="margin-left:10px;"></span>&nbsp;{{ topic.formatted_date }}</p>
						{% endif %}
						{% if topic.time %}
						<p style="font-size:15px;margin:0;"><span class="mdi-action-query-builder" style="margin-left:10px;"></span>&nbsp;{{ topic.time }}</p>
						{% endif %}
						{% if topic.expired %}
						<br>
						<p style="font-size:15px;margin:0;">{{lang.topic_overview.deadline_reach}}</p>
						{% else %}
						{% if topic.time_before_deadline %}
						<p style="font-size:15px;margin:0;">
							<span class="mdi-notification-event-busy" style="margin-left:10px;"></span>&nbsp;
							<span>
								{% if topic.time_before_deadline.days != 0 %}
								{{ topic.time_before_deadline.days }} {{lang.days}}
								{% endif %}
								{% if topic.time_before_deadline.hours != 0 %}
								{{ topic.time_before_deadline.hours }} {{lang.hours}}
								{% endif %}
								{% if topic.time_before_deadline.minutes != 0 %}
								{{ topic.time_before_deadline.minutes }} {{lang.minutes}}
								{% endif %}
							</span>
						</p>
						{% endif %}
						{% endif %}
						{% if topic.place %}
						<div id="map_canvas_topic" style="width:97%; height:200px; margin-top:10px;"></div>
						{% endif %}
					</div>
				</div>
				<div style="float:right;margin-right:25px;">
				{% if topic.is_own %}
					<button id="delete-topic" title="{{lang.buttons.delete_topic_title}}" class="btn btn-danger btn-raised mdi-action-delete" style="background-color:#DB4438"></button>
				{% endif %}

				<button id="topic-participation" title="{% if topic.participation %}{{lang.buttons.not_partecipating_title}}{% else %}{{lang.buttons.partecipating_title}}{% endif %}" class="btn btn-raised {% if topic.participation %} btn-success mdi-toggle-check-box {% else %} btn-warning mdi-toggle-check-box-outline-blank {% endif %} {% if topic.expired %} disabled {% endif %}">&nbsp;<span id="participation-text">
					{% if not topic.participation %}
					{{lang.topic_overview.not_partecipating}}
					{%else%}
					{{lang.topic_overview.partecipating}}
					{% endif %}
				</span></button>
				</div>
			</div>
		</div>
	</div>
</div>


  
<div class="list-group">
	<h2 style="margin-left:20px;">{{ lang.proposals }}</h2>
	{% if not topic.proposals %}
	<p style="margin-left:20px;">{{lang.no_proposals}}</p>
	{% endif %}
	{% for proposal in topic.proposals %}
	<div class="list-group-item">
		<div data-proposal="{{ proposal.key.id }}" data-place="{{ proposal.place }}" class="well well-lg proposal-well" color="yellow_g" style="cursor: pointer;padding: 10px 0px 0px 25px;">
			<div class="row">
				<!-- interno proposta -->
				<div class="row-picture">
					{% if proposal.creator.img %}
					<img class="circle" src="/user/{{proposal.creator.key.id}}/image" alt="icon">
					{% else %}
					<img class="circle" src="/static/images/user-default.jpg" alt="icon">
					{% endif %}
				</div>
				<div class="row-content">
					<div class="col-lg-11" style="width:70%;">
						<h3 style="font-size:20px;padding-bottom:5px;margin:0px;">
							{{ proposal.title }}
						</h3>
						{% if proposal.place %}
						<span class="mdi-communication-location-on" style="margin-left:5px;"></span> {{ proposal.place }}
						{% endif %}
						{% if proposal.formatted_date %}
						<span class="mdi-editor-insert-invitation" style="margin-left:5px;"></span> {{ proposal.formatted_date }}
						{% endif %}
						{% if proposal.time %}
						<span class="mdi-action-query-builder" style="margin-left:5px;"></span> {{ proposal.time }}
						{% endif %}
						<span class="mdi-action-account-box" style="margin-left:5px;"></span> {{ proposal.creator.name }} {{ proposal.creator.surname }}
						<span class="proposal-details-message" data-proposal="{{ proposal.key.id }}" style="display: none;"><small> (Loading...)</small></span>
						<div class="proposal-details" data-proposal="{{ proposal.key.id }}" style="display: none;">
							{% if proposal.place %}
							<div class="proposal-map" id="map_canvas_proposal" data-proposal="{{proposal.key.id}}" style="width:145%; height:200px; margin-top:10px;"></div>
							{% endif %}
							{% if proposal.description %}
							<br>
							<span class="mdi-editor-format-align-left" style="margin-left:5px;"></span> {{ proposal.description }}
							{% else%}
							<br>
							<span class="mdi-editor-format-align-left" style="margin-left:5px;"></span>{{lang.no_description}}
							{% endif %}
						</div>
					</div>	
						<button class="btn btn-primary" type="button" data-toggle="modal" data-proposal="{{ proposal.key.id }}" id="vote-button" style="padding:5px 1px 4px 5px;position:absolute;top:-5px;right:20px;background-color:#2196F3;">
							<b style="font-size:11px;">{{lang.votes}}</b>
							<span class="badge vote-number" data-proposal="{{ proposal.key.id }}">{{ proposal.vote_number }} </span>&nbsp;
						</button>
						<button id="vote" data-proposal="{{ proposal.key.id }}" type="checkbox" class="btn btn-default btn-fab btn-raised mdi-action-thumb-up vote-checkbox {% if proposal.already_voted %}proposal-voted{% else %}proposal-not-voted{% endif %} {% if topic.expired or not topic.participation %} disabled {% endif %}" style="width: 35px; height: 35px;  padding: 8px;position:absolute;top:37px;right:31px;font-size:19px;" {% if topic.expired or not topic.participation %} disabled {% endif %}></button>
					
				</div>
			</div>
		</div>
	</div>
	{% endfor %}
</div>

<!-- Form-update-image -->
<div id="updateImage" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-body" style="padding:15px 15px 0px 15px;">
				<form action="/api/group/{{topic.parent.key.id }}/topic/{{topic.key.id}}/update" method="post" class="form-horizontal" enctype="multipart/form-data" id="updateImage-form">
					<fieldset>
						<div class="form-group" >
							<label for="inputImg" class="col-lg-2 control-label">{{lang.warning_photo}}</label>
							<div class="col-lg-10">
								<input id="inputImg" type="file" name="img"/>
							</div>
						</div>
						<div class="form-group">
							<div class="modal-footer" style="padding:0px 25px 0px 0px">
								<button type="button" id="edit-cancel" class="btn btn-default" data-dismiss="modal" title="{{lang.buttons.edit_topic_photo_title}}"data-target="#updateImage" style="background-color:#bdbdbd;">{{lang.cancel}}</button>
								<button type="submit" class="btn" id="edit-image" style="background-color:#2196F3;">{{lang.edit}}</button>
							</div>
						</div>
					</fieldset>
				</form>
			</div>
		</div>
	</div>
</div>

<!-- Popup per la lista dei voti -->
<div id="voteList" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" >
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header" style="padding:0px 8px 0px 0px;">
				<button type="button" class="btn btn-raised" data-dismiss="modal" data-target="#voteList" style="float:right;padding: 5px 10px 3px 10px;background-color:#F44336;z-index:1;">X</button>
			</div>
			<div class="modal-body" style="padding-top:30px;">
				<div class="list-group" >
					<div class="well well-lg proposal-well" color="yellow_g" style="padding: 1px 5px 23px 25px;"> 
						<h2 id="prosalPopupTitle"></h2>
						<div id="proposalPopup"></div>
					</div> 
				</div>
				<div id="message"></div>
				<br>
				<div class="list-group" id="member-vote-list"></div>
			</div>
		</div>
	</div>
</div>
		



